<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚˜ë§Œì˜ ë²ˆì—­ê¸°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f4f9;
      --bg-gradient: linear-gradient(165deg, #f8f7fc 0%, #eef0f5 50%, #f0eef4 100%);
      --surface: #ffffff;
      --surface-glass: rgba(255,255,255,0.88);
      --border: #e4e2ec;
      --text: #1e1b26;
      --text-muted: #6b6578;
      --text-soft: #8e8999;
      --accent: #624eba;
      --accent-hover: #5144a3;
      --accent-light: #edeaf8;
      --accent-glow: rgba(98, 78, 186, 0.14);
      --business: #1e5aa8;
      --business-light: #e8f0fa;
      --tag: #f2f0f7;
      --shadow: 0 4px 24px rgba(30, 27, 38, 0.07);
      --shadow-hover: 0 10px 36px rgba(30, 27, 38, 0.1);
      --radius: 18px;
      --radius-sm: 12px;
      --radius-pill: 999px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse 75% 45% at 50% -15%, var(--accent-glow), transparent 55%);
      pointer-events: none;
      z-index: 0;
    }

    .header {
      position: relative;
      z-index: 10;
      background: var(--surface-glass);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .logo {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.03em;
    }

    .logo span { color: var(--accent); font-weight: 700; }

    .api-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .api-wrap input {
      width: 220px;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      background: var(--tag);
    }

    .api-wrap input::placeholder { color: var(--text-muted); }
    .api-wrap input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

    .api-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .btn-api {
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 0.85rem;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
    }

    .btn-api:hover { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }

    .hero {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 3rem 1rem 2rem;
    }

    .hero-badge {
      display: inline-block;
      padding: 0.35rem 0.9rem;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      border-radius: var(--radius-pill);
      margin-bottom: 1rem;
    }

    .hero h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.04em;
      margin-bottom: 0.5rem;
      line-height: 1.28;
    }

    .hero p {
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 400px;
      margin: 0 auto;
    }

    .main {
      position: relative;
      z-index: 1;
      max-width: 620px;
      margin: 0 auto;
      padding: 0 1.25rem 4rem;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 1.75rem;
      margin-bottom: 1.5rem;
      transition: box-shadow 0.25s ease;
    }

    .card:hover { box-shadow: var(--shadow-hover); }

    .card-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.6rem;
    }

    /* ì–¸ì–´ ì„ íƒ ë²„íŠ¼ + ë“œë¡­ë‹¤ìš´ */
    .lang-section {
      margin-bottom: 1.25rem;
    }

    .lang-trigger {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.7rem 1.1rem;
      background: var(--tag);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .lang-trigger:hover {
      border-color: var(--accent);
      background: var(--accent-light);
      color: var(--accent);
    }

    .lang-trigger .arrow {
      font-size: 0.7rem;
      opacity: 0.7;
      transition: transform 0.2s;
    }

    .lang-trigger.open .arrow { transform: rotate(180deg); }

    .lang-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 6px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-hover);
      min-width: 168px;
      z-index: 20;
      overflow: hidden;
    }

    .lang-option {
      display: block;
      width: 100%;
      padding: 0.7rem 1rem;
      border: none;
      background: none;
      font-size: 0.95rem;
      color: var(--text);
      cursor: pointer;
      text-align: left;
      font-family: inherit;
      transition: background 0.15s;
    }

    .lang-option:hover { background: var(--tag); }
    .lang-option.active { background: var(--accent-light); color: var(--accent); font-weight: 600; }

    .lang-wrap { position: relative; display: inline-block; }

    /* ë²ˆì—­ ëª¨ë“œ: ì¼ë°˜ / ë¹„ì¦ˆë‹ˆìŠ¤ */
    .mode-section { margin-bottom: 1.25rem; }

    .mode-btns {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .mode-btn {
      padding: 0.6rem 1.1rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .mode-btn:hover { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .mode-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .mode-btn.business.active { background: var(--business); border-color: var(--business); }
    .mode-btn.business:hover { border-color: var(--business); background: var(--business-light); color: var(--business); }

    .input-wrap { position: relative; }

    /* ì…ë ¥/ì¶œë ¥ */
    textarea.input-text {
      width: 100%;
      min-height: 120px;
      padding: 1rem 1rem 2rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      background: var(--surface);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    textarea.input-text::placeholder { color: var(--text-muted); }
    textarea.input-text:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

    .input-hint {
      position: absolute;
      right: 0.75rem;
      bottom: 0.5rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .image-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-image {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.5rem 0.85rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 0.8rem;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn-image:hover { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .btn-image input { display: none; }
    .image-hint { font-size: 0.7rem; color: var(--text-soft); }

    .output-box {
      margin-top: 1rem;
    }

    .output-primary {
      width: 100%;
      min-height: 100px;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 1rem;
      background: var(--tag);
      color: var(--text);
      resize: none;
      line-height: 1.6;
    }

    .output-verify {
      margin-top: 0.85rem;
      padding: 1rem 1.1rem;
      background: var(--accent-light);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(98, 78, 186, 0.2);
      font-size: 0.95rem;
      color: var(--text);
    }

    .output-verify-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 0.04em;
      margin-bottom: 0.4rem;
    }

    .translate-btn {
      width: 100%;
      padding: 1rem 1.25rem;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, transform 0.12s;
      margin-top: 1.25rem;
    }

    .translate-btn:hover { background: var(--accent-hover); }
    .translate-btn:active { transform: scale(0.99); }
    .translate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .status {
      font-size: 0.85rem;
      margin-top: 0.5rem;
      min-height: 1.2em;
      color: var(--text-soft);
    }

    .status.success { color: var(--accent); font-weight: 500; }
    .status.error { color: #c53030; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">ë‚˜ë§Œì˜ <span>ë²ˆì—­ê¸°</span></div>
    <div class="api-wrap">
      <div>
        <input type="password" id="apiKey" placeholder="API í‚¤ (ë°°í¬ í›„ í•œ ë²ˆë§Œ ì…ë ¥)" autocomplete="off" />
        <div class="api-hint">ë°°í¬í•œ ë’¤ í™˜ê²½ë³€ìˆ˜ì— í‚¤ë¥¼ ë„£ìœ¼ë©´, ê³µìœ  ë§í¬ë¡œ ë“¤ì–´ì˜¨ ì‚¬ëŒì€ í‚¤ ì—†ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
      </div>
      <button type="button" class="btn-api" id="saveApi">ì €ì¥</button>
    </div>
  </header>

  <section class="hero">
    <span class="hero-badge">ì˜ì—­ ê¸°ë°˜</span>
    <h1>ë‚˜ë§Œì˜ ë²ˆì—­ í•œë²ˆì—!</h1>
    <p>ìì—°ìŠ¤ëŸ¬ìš´ ë§ë¡œ ë²ˆì—­í•´ì„œ í™•ì¸í•˜ì„¸ìš”</p>
  </section>

  <main class="main">
    <div class="card">
      <div class="card-title">ëŒ€ìƒ ì–¸ì–´</div>
      <div class="lang-section">
        <div class="lang-wrap">
          <button type="button" class="lang-trigger" id="langTrigger" aria-haspopup="listbox" aria-expanded="false">
            <span id="langLabel">ì˜ì–´</span>
            <span class="arrow">â–¼</span>
          </button>
          <div class="lang-dropdown hidden" id="langDropdown" role="listbox">
            <button type="button" class="lang-option active" data-lang="en" data-label="ì˜ì–´" role="option">ì˜ì–´</button>
            <button type="button" class="lang-option" data-lang="th" data-label="íƒœêµ­ì–´" role="option">íƒœêµ­ì–´</button>
            <button type="button" class="lang-option" data-lang="zh" data-label="ì¤‘êµ­ì–´" role="option">ì¤‘êµ­ì–´</button>
            <button type="button" class="lang-option" data-lang="ur" data-label="ìš°ë¥´ë‘ì–´" role="option">ìš°ë¥´ë‘ì–´</button>
            <button type="button" class="lang-option" data-lang="vi" data-label="ë² íŠ¸ë‚¨ì–´" role="option">ë² íŠ¸ë‚¨ì–´</button>
            <button type="button" class="lang-option" data-lang="ko" data-label="í•œêµ­ì–´" role="option">í•œêµ­ì–´</button>
          </div>
        </div>
      </div>

      <div class="card-title">ë²ˆì—­ ëª¨ë“œ</div>
      <div class="mode-section">
        <div class="mode-btns">
          <button type="button" class="mode-btn active" data-mode="general">ì¼ë°˜ ë¹ ë¥¸ ë²ˆì—­</button>
          <button type="button" class="mode-btn business" data-mode="business">ë¹„ì¦ˆë‹ˆìŠ¤ ë²ˆì—­</button>
        </div>
      </div>

      <div class="card-title">ì›ë¬¸ (ìë™ ì–¸ì–´ ê°ì§€)</div>
      <div class="input-wrap">
        <textarea class="input-text" id="input" placeholder="ë²ˆì—­í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì–¸ì–´ ìë™ ê°ì§€)..." autofocus></textarea>
        <span class="input-hint">Enterë¡œ ë²ˆì—­ Â· Shift+Enter ì¤„ë°”ê¿ˆ</span>
      </div>
      <div class="image-actions">
        <label class="btn-image">
          <input type="file" id="imageFile" accept="image/*" capture="environment" />
          ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ
        </label>
        <span class="image-hint">ìº¡ì²˜/ì‚¬ì§„ ë¶™ì—¬ë„£ê¸°(Ctrl+V) â†’ ìë™ ì¸ì‹ í›„ ë²ˆì—­</span>
      </div>

      <button type="button" class="translate-btn" id="translateBtn">ë²ˆì—­í•˜ê¸°</button>
      <div id="status" class="status"></div>

      <div class="output-box hidden" id="outputBox">
        <div class="card-title">ë²ˆì—­ ê²°ê³¼</div>
        <div class="output-primary" id="output" readonly></div>
        <div class="output-verify">
          <div class="output-verify-label">í•œêµ­ì–´ë¡œ í™•ì¸</div>
          <div id="outputVerify"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const LANG_MAP = {
      en: 'English',
      th: 'Thai',
      zh: 'Chinese',
      ur: 'Urdu',
      vi: 'Vietnamese',
      ko: 'Korean'
    };

    const apiKeyInput = document.getElementById('apiKey');
    const saveApiBtn = document.getElementById('saveApi');
    const langTrigger = document.getElementById('langTrigger');
    const langLabel = document.getElementById('langLabel');
    const langDropdown = document.getElementById('langDropdown');
    const langOptions = document.querySelectorAll('.lang-option');
    const modeBtns = document.querySelectorAll('.mode-btn');
    const input = document.getElementById('input');
    const translateBtn = document.getElementById('translateBtn');
    const status = document.getElementById('status');
    const outputBox = document.getElementById('outputBox');
    const output = document.getElementById('output');
    const outputVerify = document.getElementById('outputVerify');

    let currentLang = 'en';
    let currentMode = 'general';

    if (localStorage.getItem('openai_api_key')) {
      apiKeyInput.value = localStorage.getItem('openai_api_key');
      apiKeyInput.placeholder = 'API í‚¤ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤';
    }

    saveApiBtn.addEventListener('click', () => {
      const key = apiKeyInput.value.trim();
      if (key) {
        localStorage.setItem('openai_api_key', key);
        apiKeyInput.placeholder = 'ì €ì¥ë¨';
        apiKeyInput.value = '';
        apiKeyInput.type = 'password';
      }
    });

    langTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      langDropdown.classList.toggle('hidden');
      langTrigger.classList.toggle('open');
    });

    document.addEventListener('click', () => {
      langDropdown.classList.add('hidden');
      langTrigger.classList.remove('open');
    });

    langOptions.forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.stopPropagation();
        currentLang = opt.dataset.lang;
        langLabel.textContent = opt.dataset.label;
        langOptions.forEach(o => o.classList.remove('active'));
        opt.classList.add('active');
        langDropdown.classList.add('hidden');
        langTrigger.classList.remove('open');
      });
    });

    modeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        modeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;
      });
    });

    function setStatus(msg, type = '') {
      status.textContent = msg;
      status.className = 'status ' + type;
    }

    function getSystemPrompt() {
      const langName = LANG_MAP[currentLang] || currentLang;
      const base = `You are a professional translator. First detect the source language of the user's text, then translate it to ${langName}.
Rules:
- Auto-detect the source language (e.g. Korean, English, Japanese, Chinese, etc.). Do not ask or explain.
- Prefer natural, meaning-based translation (ì˜ì—­). Do NOT do word-by-word literal translation (ì§ì—­).
- If the text is already in ${langName}, you may output it as-is or lightly refine. Still output ONLY the final text.
- Output ONLY the translated text, no explanations, quotes, or language labels.`;
      if (currentMode === 'business') {
        return base + `
- Use a formal, highly polite business tone (ì •ì¤‘í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¬¸ì²´).
- Prefer honorific and refined expressions; avoid casual or slang.
- Use professional terminology appropriate for contracts, emails, reports, and official documents.
- Choose sophisticated vocabulary that sounds credible in a corporate setting.
- Maintain consistency with standard business writing conventions in the target language.`;
      }
      return base + '\n- Use natural, conversational tone.';
    }

    async function callOpenAI(messages) {
      // 1) ë¨¼ì € ë°°í¬ëœ ì„œë²„ API ì‹œë„ (ê³µìœ  ë§í¬ì—ì„œëŠ” ì´ê±¸ë¡œ ë™ì‘, API í‚¤ ë¶ˆí•„ìš”)
      try {
        const res = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.content !== undefined) return data.content;
        if (res.status === 500 && data.error && data.error.includes('not configured')) {
          throw new Error('ì„œë²„ì— API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        if (res.status !== 404) throw new Error(data.error || data.message || res.statusText);
      } catch (e) {
        if (e.message && e.message.includes('API í‚¤')) throw e;
      }

      // 2) ì„œë²„ ì—†ì„ ë•Œ: ë¡œì»¬ìš© API í‚¤ë¡œ ì§ì ‘ OpenAI í˜¸ì¶œ
      const key = localStorage.getItem('openai_api_key');
      if (!key) {
        setStatus('ë°°í¬ëœ ë§í¬ê°€ ì•„ë‹ˆë©´ API í‚¤ë¥¼ í•œ ë²ˆ ì €ì¥í•´ ì£¼ì„¸ìš”.', 'error');
        return null;
      }

      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + key
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages,
          temperature: 0.3,
          max_tokens: 2000
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error?.message || res.statusText || 'API ì˜¤ë¥˜');
      const content = data.choices?.[0]?.message?.content?.trim();
      if (!content) throw new Error('ë¹ˆ ì‘ë‹µ');
      return content;
    }

    async function translate() {
      const text = input.value.trim();
      if (!text) {
        setStatus('ë²ˆì—­í•  ë¬¸ì¥ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
        return;
      }

      translateBtn.disabled = true;
      setStatus('ë²ˆì—­ ì¤‘...');
      outputBox.classList.add('hidden');

      try {
        const systemPrompt = getSystemPrompt();
        const translated = await callOpenAI([
          { role: 'system', content: systemPrompt },
          { role: 'user', content: text }
        ]);

        if (!translated) {
          translateBtn.disabled = false;
          return;
        }

        output.textContent = translated;
        outputBox.classList.remove('hidden');

        if (currentLang === 'ko') {
          outputVerify.textContent = translated;
          setStatus('ë²ˆì—­ ì™„ë£Œ', 'success');
        } else {
          setStatus('í•œêµ­ì–´ë¡œ í™•ì¸ ì¤‘...');
          const verifyPrompt = `You are a translator. Translate the following text from ${LANG_MAP[currentLang]} to Korean. Output ONLY the Korean translation, nothing else.`;
          const verifiedKo = await callOpenAI([
            { role: 'system', content: verifyPrompt },
            { role: 'user', content: translated }
          ]);
          if (verifiedKo) {
            outputVerify.textContent = verifiedKo;
            setStatus('ë²ˆì—­ ì™„ë£Œ', 'success');
          } else {
            outputVerify.textContent = '(ê²€ì¦ ë²ˆì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤)';
            setStatus('ë²ˆì—­ ì™„ë£Œ', 'success');
          }
        }
      } catch (err) {
        setStatus(err.message || 'ë²ˆì—­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        outputBox.classList.add('hidden');
      }

      translateBtn.disabled = false;
    }

    translateBtn.addEventListener('click', translate);
    input.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      if (e.shiftKey) return; // Shift+Enter = ì¤„ë°”ê¿ˆ
      e.preventDefault();
      translate();
    });

    async function extractTextFromImage(base64) {
      const dataUrl = base64.startsWith('data:') ? base64 : 'data:image/png;base64,' + base64;
      try {
        const res = await fetch('/api/vision', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataUrl })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.content !== undefined) return data.content;
        if (res.status !== 404) throw new Error(data.error || 'ì´ë¯¸ì§€ ì¸ì‹ ì‹¤íŒ¨');
      } catch (e) {
        if (e.message && e.message.includes('API í‚¤')) throw e;
      }
      const key = localStorage.getItem('openai_api_key');
      if (!key) throw new Error('ì´ë¯¸ì§€ ì¸ì‹ì€ ë°°í¬ëœ ë§í¬ ë˜ëŠ” API í‚¤ ì €ì¥ í›„ ì‚¬ìš©í•˜ì„¸ìš”.');
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          max_tokens: 2000,
          messages: [{
            role: 'user',
            content: [
              { type: 'text', text: 'Extract all text from this image exactly as it appears. Preserve line breaks. Output ONLY the raw extracted text, nothing else.' },
              { type: 'image_url', image_url: { url: dataUrl } }
            ]
          }]
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error?.message || 'ì´ë¯¸ì§€ ì¸ì‹ ì‹¤íŒ¨');
      return (data.choices?.[0]?.message?.content || '').trim();
    }

    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function handleImage(imageDataUrl) {
      setStatus('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¸ì‹ ì¤‘...');
      try {
        const text = await extractTextFromImage(imageDataUrl);
        if (!text) {
          setStatus('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
          return;
        }
        input.value = text;
        setStatus('ì¸ì‹ ì™„ë£Œ. ë²ˆì—­ ì¤‘...', 'success');
        await translate();
      } catch (err) {
        setStatus(err.message || 'ì´ë¯¸ì§€ ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    document.addEventListener('paste', (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) readFileAsDataUrl(file).then(handleImage);
          break;
        }
      }
    });

    document.getElementById('imageFile').addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file || !file.type.startsWith('image/')) return;
      e.target.value = '';
      readFileAsDataUrl(file).then(handleImage);
    });
  </script>
</body>
</html>
